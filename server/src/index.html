<!DOCTYPE html>
<html>
  <head>
    <title>Smart Bin Monitor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
  </head>
  <body>
    <h1>Smart Bin: <span id="status">รอขยะ...</span></h1>
    <div id="result"></div>

    <script>
      // ตั้งค่า Broker (ตัวอย่างใช้ Public Broker ของ HiveMQ)
      // **สำคัญ**: ต้องใช้ Host และ Port ที่รองรับ WebSockets
      const broker = "broker.hivemq.com";
      const port = 8000;
      const topic = "myproject/smartbin/detect"; // ตั้งชื่อ Topic ให้ตรงกับ KidBright

      // สร้าง Client ID สุ่ม
      const clientID = "client-" + Math.random().toString(16).substr(2, 8);
      const client = new Paho.MQTT.Client(broker, port, clientID);

      // กำหนด Callback functions
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      // เริ่มเชื่อมต่อ
      client.connect({ onSuccess: onConnect });

      function onConnect() {
        console.log("Connected via WebSockets!");
        // สมัครรับข้อมูล (Subscribe)
        client.subscribe(topic);
      }

      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Connection Lost: " + responseObject.errorMessage);
        }
      }

      // *** ฟังก์ชันสำคัญ: ทำงานเมื่อได้รับข้อมูล ***
      function onMessageArrived(message) {
        console.log("ได้รับข้อมูล: " + message.payloadString);

        try {
          // 1. แปลง JSON String เป็น Object
          const data = JSON.parse(message.payloadString);

          // 2. ดึงค่าขยะออกมาใช้งาน
          const trashType = data.trash_type;

          // 3. แสดงผลหรือคำนวณแต้ม
          document.getElementById("status").innerText = "ตรวจพบ: " + trashType;

          // Logic การแจกแต้ม
          if (trashType === "plastic_bottle") {
            addPoints(10);
          } else if (trashType === "can") {
            addPoints(20);
          }
        } catch (e) {
          console.error("Data format ผิดพลาด", e);
        }
      }

      function addPoints(points) {
        // เขียน Logic เพิ่มแต้มตรงนี้
        alert(`คุณได้รับ ${points} แต้ม!`);
      }
    </script>
  </body>
</html>
